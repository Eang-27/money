<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Money Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background for a modern feel */
            overscroll-behavior: none;
        }
        .tab-active {
            border-bottom-color: #4f46e5; /* Indigo-600 */
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom-color: transparent;
            color: #6b7280; /* Gray-500 */
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.12);
        }
        /* Custom scrollbar for transaction list */
        .transaction-list::-webkit-scrollbar {
            width: 6px;
        }
        .transaction-list::-webkit-scrollbar-track {
            background: #e5e7eb; /* gray-200 */
            border-radius: 10px;
        }
        .transaction-list::-webkit-scrollbar-thumb {
            background: #9ca3af; /* gray-400 */
            border-radius: 10px;
        }
        .transaction-list::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        .input-field {
            border: 1px solid #d1d5db; /* gray-300 */
            padding: 10px 12px;
            border-radius: 8px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .input-field:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
            outline: none;
        }
        .btn-primary {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-700 */
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
        }
        .btn-danger {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626; /* red-600 */
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="appLoader" class="fixed inset-0 bg-white/80 backdrop-blur-sm flex flex-col justify-center items-center z-[99999]">
        <svg class="animate-spin h-12 w-12 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-lg text-indigo-600 font-semibold">Loading Your Finances...</p>
        <p class="text-sm text-gray-500 mt-1">User ID: <span id="loadingUserId">Initializing...</span></p>
    </div>

    <div class="container mx-auto max-w-5xl p-4 sm:p-6">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-indigo-700">Money Manager Pro</h1>
            <div class="text-xs text-gray-500 mt-2 sm:mt-0">
                User ID: <span id="userIdDisplay" class="font-mono"></span>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <nav class="mb-6 bg-white p-2 rounded-xl shadow-md">
            <ul class="flex space-x-2 sm:space-x-4 justify-around">
                <li><button data-tab="dashboard" class="tab-btn tab-active text-sm sm:text-base py-3 px-2 sm:px-4 border-b-2">Dashboard</button></li>
                <li><button data-tab="transactions" class="tab-btn tab-inactive text-sm sm:text-base py-3 px-2 sm:px-4 border-b-2">Transactions</button></li>
                <li><button data-tab="add" class="tab-btn tab-inactive text-sm sm:text-base py-3 px-2 sm:px-4 border-b-2">Add New</button></li>
                <li><button data-tab="budgets" class="tab-btn tab-inactive text-sm sm:text-base py-3 px-2 sm:px-4 border-b-2">Budgets</button></li>
                <li><button data-tab="reports" class="tab-btn tab-inactive text-sm sm:text-base py-3 px-2 sm:px-4 border-b-2">Reports</button></li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main id="appContent">
            <!-- Dashboard Section -->
            <section id="dashboard" class="tab-content space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Monthly Overview</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
                    <div class="card">
                        <h3 class="text-lg font-medium text-green-600">Total Income</h3>
                        <p id="totalIncome" class="text-3xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-medium text-red-600">Total Expenses</h3>
                        <p id="totalExpenses" class="text-3xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="card">
                        <h3 class="text-lg font-medium text-blue-600">Net Savings</h3>
                        <p id="netSavings" class="text-3xl font-bold mt-1">$0.00</p>
                    </div>
                </div>
                <div class="card mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Income vs Expense Trend</h3>
                    <canvas id="incomeExpenseChart" height="150"></canvas>
                </div>
            </section>

            <!-- Transactions Section -->
            <section id="transactions" class="tab-content hidden space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700">All Transactions</h2>
                <div class="card">
                    <div class="flex flex-col sm:flex-row gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                        <input type="month" id="filterMonth" class="input-field flex-grow" title="Filter by month">
                        <select id="filterCategory" class="input-field flex-grow" title="Filter by category">
                            <option value="">All Categories</option>
                            <!-- Categories will be populated here -->
                        </select>
                        <select id="filterType" class="input-field flex-grow" title="Filter by type">
                            <option value="">All Types</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                        <button id="applyFiltersBtn" class="btn-primary px-6">Filter</button>
                    </div>
                    <div id="transactionList" class="transaction-list max-h-[60vh] overflow-y-auto space-y-3 pr-2">
                        <!-- Transactions will be listed here -->
                        <p class="text-gray-500 text-center py-4">No transactions yet. Add one!</p>
                    </div>
                </div>
            </section>

            <!-- Add New Transaction/Budget Section -->
            <section id="add" class="tab-content hidden space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add New Transaction</h2>
                    <form id="addTransactionForm" class="space-y-4">
                        <div>
                            <label for="transactionType" class="block text-sm font-medium text-gray-700">Type</label>
                            <select id="transactionType" class="input-field w-full mt-1" required>
                                <option value="expense">Expense</option>
                                <option value="income">Income</option>
                            </select>
                        </div>
                        <div>
                            <label for="transactionAmount" class="block text-sm font-medium text-gray-700">Amount ($)</label>
                            <input type="number" id="transactionAmount" step="0.01" class="input-field w-full mt-1" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="transactionCategory" class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="transactionCategory" class="input-field w-full mt-1" placeholder="e.g., Groceries, Salary" required list="commonCategories">
                            <datalist id="commonCategories">
                                <option value="Groceries">
                                <option value="Salary">
                                <option value="Rent">
                                <option value="Utilities">
                                <option value="Transport">
                                <option value="Entertainment">
                                <option value="Healthcare">
                                <option value="Dining Out">
                                <option value="Shopping">
                                <option value="Freelance">
                                <option value="Investment">
                            </datalist>
                        </div>
                        <div>
                            <label for="transactionDate" class="block text-sm font-medium text-gray-700">Date</label>
                            <input type="date" id="transactionDate" class="input-field w-full mt-1" required>
                        </div>
                        <div>
                            <label for="transactionNote" class="block text-sm font-medium text-gray-700">Note (Optional)</label>
                            <textarea id="transactionNote" rows="3" class="input-field w-full mt-1" placeholder="e.g., Weekly grocery run"></textarea>
                        </div>
                        <button type="submit" class="btn-primary w-full">Add Transaction</button>
                    </form>
                </div>
            </section>

            <!-- Budgets Section -->
            <section id="budgets" class="tab-content hidden space-y-6">
                 <div class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Set & Track Budgets</h2>
                    <form id="addBudgetForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end mb-6 p-4 bg-gray-50 rounded-lg">
                        <div>
                            <label for="budgetCategory" class="block text-sm font-medium text-gray-700">Category</label>
                            <input type="text" id="budgetCategory" class="input-field w-full mt-1" placeholder="e.g., Groceries" required list="commonCategories">
                        </div>
                        <div>
                            <label for="budgetLimit" class="block text-sm font-medium text-gray-700">Monthly Limit ($)</label>
                            <input type="number" id="budgetLimit" step="0.01" class="input-field w-full mt-1" placeholder="e.g., 500" required>
                        </div>
                        <button type="submit" class="btn-primary w-full sm:w-auto h-fit">Set Budget</button>
                    </form>
                    <div id="budgetList" class="space-y-4">
                        <!-- Budgets will be listed here -->
                        <p class="text-gray-500 text-center py-4">No budgets set yet.</p>
                    </div>
                </div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="tab-content hidden space-y-6">
                <div class="card">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Expense Breakdown</h2>
                    <div class="mb-4">
                        <label for="reportMonth" class="block text-sm font-medium text-gray-700">Select Month:</label>
                        <input type="month" id="reportMonth" class="input-field mt-1">
                    </div>
                    <canvas id="expenseByCategoryChart" height="200"></canvas>
                    <p id="reportMessage" class="text-gray-500 text-center py-4 hidden">No expense data for the selected month.</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Generic Modal for Editing/Confirmation -->
    <div id="genericModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" class="text-xl font-semibold mb-4">Modal Title</h3>
            <div id="modalBody" class="mb-6">
                <!-- Modal content goes here -->
            </div>
            <div id="modalFooter" class="flex justify-end space-x-3">
                <button id="modalCancelBtn" class="btn-secondary">Cancel</button>
                <button id="modalConfirmBtn" class="btn-primary">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, serverTimestamp, writeBatch, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-money-manager';

        let app;
        if (!getApps().length) {
            app = initializeApp(firebaseConfig);
        } else {
            app = getApp();
        }
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let transactionsUnsubscribe = null;
        let budgetsUnsubscribe = null;
        let allTransactions = []; // Local cache for transactions
        let allBudgets = []; // Local cache for budgets

        // --- UI Elements ---
        const appLoader = document.getElementById('appLoader');
        const loadingUserId = document.getElementById('loadingUserId');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // Dashboard
        const totalIncomeEl = document.getElementById('totalIncome');
        const totalExpensesEl = document.getElementById('totalExpenses');
        const netSavingsEl = document.getElementById('netSavings');

        // Transactions
        const transactionListEl = document.getElementById('transactionList');
        const filterMonthEl = document.getElementById('filterMonth');
        const filterCategoryEl = document.getElementById('filterCategory');
        const filterTypeEl = document.getElementById('filterType');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');

        // Add Transaction
        const addTransactionForm = document.getElementById('addTransactionForm');
        const transactionTypeEl = document.getElementById('transactionType');
        const transactionAmountEl = document.getElementById('transactionAmount');
        const transactionCategoryEl = document.getElementById('transactionCategory');
        const transactionDateEl = document.getElementById('transactionDate');
        const transactionNoteEl = document.getElementById('transactionNote');

        // Budgets
        const addBudgetForm = document.getElementById('addBudgetForm');
        const budgetCategoryEl = document.getElementById('budgetCategory');
        const budgetLimitEl = document.getElementById('budgetLimit');
        const budgetListEl = document.getElementById('budgetList');

        // Reports
        const reportMonthEl = document.getElementById('reportMonth');
        const expenseByCategoryChartEl = document.getElementById('expenseByCategoryChart').getContext('2d');
        const reportMessageEl = document.getElementById('reportMessage');
        let incomeExpenseChartInstance = null;
        let expenseByCategoryChartInstance = null;

        // Modal
        const genericModal = document.getElementById('genericModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalBodyEl = document.getElementById('modalBody');
        const modalCancelBtn = document.getElementById('modalCancelBtn');
        const modalConfirmBtn = document.getElementById('modalConfirmBtn');
        let currentEditId = null;
        let currentEditType = ''; // 'transaction' or 'budget'


        // --- Helper Functions ---
        const formatDate = (date) => {
            if (date instanceof Timestamp) {
                date = date.toDate();
            } else if (typeof date === 'string' && !isNaN(new Date(date))) {
                 date = new Date(date);
            } else if (!(date instanceof Date)) {
                return 'Invalid Date';
            }
            return date.toLocaleDateString('en-CA'); // YYYY-MM-DD for input[type=date]
        };

        const formatCurrency = (amount) => {
            return `$${Number(amount).toFixed(2)}`;
        };

        const getCurrentMonthYear = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        };

        // --- Authentication ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                loadingUserId.textContent = userId;
                console.log("User authenticated:", userId);
                initializeAppState();
            } else {
                loadingUserId.textContent = "Authenticating...";
                try {
                    await setPersistence(auth, browserLocalPersistence);
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    loadingUserId.textContent = "Auth Error!";
                    appLoader.innerHTML = '<p class="text-red-500 text-center">Authentication failed. Please refresh.</p>';
                }
            }
        });

        function initializeAppState() {
            if (!userId) return;
            loadTransactions();
            loadBudgets();
            setupEventListeners();
            // Set default dates for filters
            filterMonthEl.value = getCurrentMonthYear();
            reportMonthEl.value = getCurrentMonthYear();
            transactionDateEl.value = formatDate(new Date()); // Today's date for new transaction
            appLoader.style.display = 'none'; // Hide loader
            activateTab('dashboard'); // Show dashboard by default
        }

        // --- Tab Navigation ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => activateTab(tab.dataset.tab));
        });

        function activateTab(tabName) {
            tabs.forEach(tab => {
                tab.classList.toggle('tab-active', tab.dataset.tab === tabName);
                tab.classList.toggle('tab-inactive', tab.dataset.tab !== tabName);
            });
            tabContents.forEach(content => {
                content.classList.toggle('hidden', content.id !== tabName);
            });
            // Refresh charts or data if needed when a tab is activated
            if (tabName === 'dashboard') updateDashboard();
            if (tabName === 'reports') updateExpenseByCategoryChart();
            if (tabName === 'transactions') renderTransactions(allTransactions); // Re-render with current filters
        }

        // --- Firestore Operations ---
        // Transactions
        async function addTransaction(data) {
            if (!userId) return;
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/transactions`), {
                    ...data,
                    amount: parseFloat(data.amount),
                    createdAt: serverTimestamp()
                });
                console.log("Transaction added");
            } catch (e) { console.error("Error adding transaction: ", e); }
        }

        async function updateTransaction(id, data) {
            if (!userId) return;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/transactions`, id);
                await updateDoc(docRef, {
                    ...data,
                    amount: parseFloat(data.amount)
                });
                console.log("Transaction updated");
            } catch (e) { console.error("Error updating transaction: ", e); }
        }

        async function deleteTransaction(id) {
            if (!userId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/transactions`, id));
                console.log("Transaction deleted");
            } catch (e) { console.error("Error deleting transaction: ", e); }
        }

        function loadTransactions() {
            if (!userId) return;
            if (transactionsUnsubscribe) transactionsUnsubscribe();

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/transactions`));
            transactionsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allTransactions = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allTransactions.sort((a,b) => (b.date > a.date) ? 1 : ((a.date > b.date) ? -1 : 0)); // Sort by date desc
                
                populateCategoryFilter();
                renderTransactions(getFilteredTransactions());
                updateDashboard();
                updateExpenseByCategoryChart(); // Update report chart if visible
            }, (error) => console.error("Error loading transactions:", error));
        }

        // Budgets
        async function addOrUpdateBudget(data) {
            if (!userId) return;
            try {
                // Check if budget for this category and monthYear already exists
                const budgetQuery = query(
                    collection(db, `artifacts/${appId}/users/${userId}/budgets`),
                    where("category", "==", data.category),
                    where("monthYear", "==", data.monthYear)
                );
                const querySnapshot = await getDocs(budgetQuery);
                if (!querySnapshot.empty) {
                    // Update existing budget
                    const budgetDoc = querySnapshot.docs[0];
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/budgets`, budgetDoc.id), {
                        limit: parseFloat(data.limit),
                        updatedAt: serverTimestamp()
                    });
                    console.log("Budget updated for", data.category);
                } else {
                    // Add new budget
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/budgets`), {
                        ...data,
                        limit: parseFloat(data.limit),
                        createdAt: serverTimestamp()
                    });
                    console.log("Budget added for", data.category);
                }
            } catch (e) { console.error("Error adding/updating budget: ", e); }
        }
        
        async function deleteBudget(id) {
            if (!userId) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/budgets`, id));
                console.log("Budget deleted");
            } catch (e) { console.error("Error deleting budget: ", e); }
        }

        function loadBudgets() {
            if (!userId) return;
            if (budgetsUnsubscribe) budgetsUnsubscribe();

            const q = query(collection(db, `artifacts/${appId}/users/${userId}/budgets`));
            budgetsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                allBudgets = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                renderBudgets();
                updateDashboard(); // Budgets might affect dashboard display
            }, (error) => console.error("Error loading budgets:", error));
        }

        // --- UI Rendering & Updates ---
        function populateCategoryFilter() {
            const categories = [...new Set(allTransactions.map(t => t.category))].sort();
            filterCategoryEl.innerHTML = '<option value="">All Categories</option>'; // Reset
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                filterCategoryEl.appendChild(option);
            });
        }

        function getFilteredTransactions() {
            const monthFilter = filterMonthEl.value; // YYYY-MM
            const categoryFilter = filterCategoryEl.value;
            const typeFilter = filterTypeEl.value;

            return allTransactions.filter(t => {
                const transactionDate = new Date(t.date instanceof Timestamp ? t.date.toDate() : t.date);
                const transactionMonthYear = `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}`;
                
                const monthMatch = !monthFilter || transactionMonthYear === monthFilter;
                const categoryMatch = !categoryFilter || t.category === categoryFilter;
                const typeMatch = !typeFilter || t.type === typeFilter;
                return monthMatch && categoryMatch && typeMatch;
            });
        }
        
        function renderTransactions(transactionsToRender) {
            transactionListEl.innerHTML = ''; // Clear list
            if (transactionsToRender.length === 0) {
                transactionListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No transactions match your filters or none added yet.</p>';
                return;
            }

            transactionsToRender.forEach(t => {
                const item = document.createElement('div');
                item.className = `p-4 rounded-lg shadow flex justify-between items-center transition-all duration-200 ${t.type === 'income' ? 'bg-green-50 hover:bg-green-100 border-l-4 border-green-500' : 'bg-red-50 hover:bg-red-100 border-l-4 border-red-500'}`;
                item.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800 text-lg">${t.category} <span class="text-sm font-normal text-gray-500">(${t.type})</span></p>
                        <p class="text-sm text-gray-600">${t.note || 'No note'}</p>
                        <p class="text-xs text-gray-400">${formatDate(t.date)}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-xl ${t.type === 'income' ? 'text-green-600' : 'text-red-600'}">${formatCurrency(t.amount)}</p>
                        <div class="mt-1 space-x-2">
                            <button data-id="${t.id}" class="edit-transaction-btn text-xs text-blue-500 hover:text-blue-700">Edit</button>
                            <button data-id="${t.id}" class="delete-transaction-btn text-xs text-red-500 hover:text-red-700">Delete</button>
                        </div>
                    </div>
                `;
                transactionListEl.appendChild(item);
            });

            // Add event listeners for new edit/delete buttons
            document.querySelectorAll('.edit-transaction-btn').forEach(btn => btn.addEventListener('click', handleEditTransaction));
            document.querySelectorAll('.delete-transaction-btn').forEach(btn => btn.addEventListener('click', handleDeleteTransaction));
        }

        function updateDashboard() {
            const currentMonth = filterMonthEl.value || getCurrentMonthYear(); // Use filter month or current month
            const transactionsThisMonth = allTransactions.filter(t => {
                const transactionDate = new Date(t.date instanceof Timestamp ? t.date.toDate() : t.date);
                return `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}` === currentMonth;
            });

            const income = transactionsThisMonth.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expenses = transactionsThisMonth.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const savings = income - expenses;

            totalIncomeEl.textContent = formatCurrency(income);
            totalExpensesEl.textContent = formatCurrency(expenses);
            netSavingsEl.textContent = formatCurrency(savings);
            netSavingsEl.className = `text-3xl font-bold mt-1 ${savings >= 0 ? 'text-blue-600' : 'text-orange-500'}`;
            
            updateIncomeExpenseChart(transactionsThisMonth);
        }

        function renderBudgets() {
            budgetListEl.innerHTML = '';
            const currentMonthYearVal = getCurrentMonthYear();

            const budgetsForCurrentMonth = allBudgets.filter(b => b.monthYear === currentMonthYearVal);

            if (budgetsForCurrentMonth.length === 0) {
                budgetListEl.innerHTML = '<p class="text-gray-500 text-center py-4">No budgets set for the current month.</p>';
                return;
            }

            budgetsForCurrentMonth.forEach(b => {
                const expensesForCategory = allTransactions
                    .filter(t => t.type === 'expense' && t.category === b.category && 
                                (new Date(t.date instanceof Timestamp ? t.date.toDate() : t.date).getFullYear() + '-' + String(new Date(t.date instanceof Timestamp ? t.date.toDate() : t.date).getMonth() + 1).padStart(2, '0')) === currentMonthYearVal)
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const percentageSpent = (expensesForCategory / b.limit) * 100;
                const remaining = b.limit - expensesForCategory;
                
                let progressBarColor = 'bg-green-500';
                if (percentageSpent > 75 && percentageSpent <= 100) progressBarColor = 'bg-yellow-500';
                else if (percentageSpent > 100) progressBarColor = 'bg-red-500';

                const item = document.createElement('div');
                item.className = 'p-4 rounded-lg shadow-sm border border-gray-200 bg-white';
                item.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h4 class="font-semibold text-gray-700 text-lg">${b.category}</h4>
                        <div class="space-x-2">
                            <button data-id="${b.id}" class="edit-budget-btn text-xs text-blue-500 hover:text-blue-700">Edit</button>
                            <button data-id="${b.id}" class="delete-budget-btn text-xs text-red-500 hover:text-red-700">Delete</button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-500">Limit: ${formatCurrency(b.limit)} | Spent: ${formatCurrency(expensesForCategory)}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${Math.min(percentageSpent, 100)}%"></div>
                    </div>
                    <p class="text-xs mt-1 ${remaining < 0 ? 'text-red-600' : 'text-green-600'}">
                        ${remaining < 0 ? `Overspent by ${formatCurrency(Math.abs(remaining))}` : `${formatCurrency(remaining)} Remaining`}
                    </p>
                `;
                budgetListEl.appendChild(item);
            });
            document.querySelectorAll('.edit-budget-btn').forEach(btn => btn.addEventListener('click', handleEditBudget));
            document.querySelectorAll('.delete-budget-btn').forEach(btn => btn.addEventListener('click', handleDeleteBudget));
        }

        // --- Charting ---
        function updateIncomeExpenseChart(transactionsThisMonth) {
            if (incomeExpenseChartInstance) {
                incomeExpenseChartInstance.destroy();
            }
            // Aggregate data by day for the current month
            const dailyData = {};
            const currentMonthDate = new Date(filterMonthEl.value + "-01" || getCurrentMonthYear() + "-01"); // Ensure it's the first of the month
            const daysInMonth = new Date(currentMonthDate.getFullYear(), currentMonthDate.getMonth() + 1, 0).getDate();
            
            const labels = Array.from({length: daysInMonth}, (_, i) => i + 1);

            labels.forEach(day => {
                dailyData[day] = { income: 0, expense: 0 };
            });

            transactionsThisMonth.forEach(t => {
                const day = new Date(t.date instanceof Timestamp ? t.date.toDate() : t.date).getDate();
                if (t.type === 'income') dailyData[day].income += t.amount;
                else dailyData[day].expense += t.amount;
            });

            const incomeData = labels.map(day => dailyData[day].income);
            const expenseData = labels.map(day => dailyData[day].expense);
            
            const ctx = document.getElementById('incomeExpenseChart').getContext('2d');
            incomeExpenseChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.1,
                            fill: true,
                        },
                        {
                            label: 'Expenses',
                            data: expenseData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.1,
                            fill: true,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function updateExpenseByCategoryChart() {
            if (expenseByCategoryChartInstance) {
                expenseByCategoryChartInstance.destroy();
            }
            const selectedMonth = reportMonthEl.value || getCurrentMonthYear();
            const expensesThisMonth = allTransactions.filter(t => {
                const transactionDate = new Date(t.date instanceof Timestamp ? t.date.toDate() : t.date);
                return t.type === 'expense' && 
                       `${transactionDate.getFullYear()}-${String(transactionDate.getMonth() + 1).padStart(2, '0')}` === selectedMonth;
            });

            if (expensesThisMonth.length === 0) {
                reportMessageEl.classList.remove('hidden');
                expenseByCategoryChartEl.canvas.classList.add('hidden');
                return;
            }
            reportMessageEl.classList.add('hidden');
            expenseByCategoryChartEl.canvas.classList.remove('hidden');


            const expensesByCategory = expensesThisMonth.reduce((acc, t) => {
                acc[t.category] = (acc[t.category] || 0) + t.amount;
                return acc;
            }, {});

            const labels = Object.keys(expensesByCategory);
            const data = Object.values(expensesByCategory);
            
            const backgroundColors = labels.map((_, i) => `hsl(${(i * 360 / labels.length) % 360}, 70%, 60%)`);


            expenseByCategoryChartInstance = new Chart(expenseByCategoryChartEl, {
                type: 'pie', // or 'doughnut'
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expenses by Category',
                        data: data,
                        backgroundColor: backgroundColors,
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { position: 'top'}}}
            });
        }


        // --- Event Listeners Setup ---
        function setupEventListeners() {
            addTransactionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    type: transactionTypeEl.value,
                    amount: transactionAmountEl.value,
                    category: transactionCategoryEl.value.trim(),
                    date: transactionDateEl.value, // Already YYYY-MM-DD
                    note: transactionNoteEl.value.trim()
                };
                if (!data.category) { alert("Category cannot be empty."); return; }
                await addTransaction(data);
                addTransactionForm.reset();
                transactionDateEl.value = formatDate(new Date()); // Reset date to today
                activateTab('transactions'); // Switch to transactions view
            });

            addBudgetForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    category: budgetCategoryEl.value.trim(),
                    limit: budgetLimitEl.value,
                    monthYear: getCurrentMonthYear() // Budget for the current month
                };
                if (!data.category) { alert("Category cannot be empty."); return; }
                await addOrUpdateBudget(data);
                addBudgetForm.reset();
            });

            applyFiltersBtn.addEventListener('click', () => {
                renderTransactions(getFilteredTransactions());
            });
            
            reportMonthEl.addEventListener('change', updateExpenseByCategoryChart);

            // Modal listeners
            modalCancelBtn.addEventListener('click', closeModal);
            genericModal.addEventListener('click', (e) => { // Close on overlay click
                if (e.target === genericModal) closeModal();
            });
        }

        // --- Modal Handling for Edit/Delete ---
        function openModal(title, bodyContent, confirmCallback, confirmText = "Save Changes") {
            modalTitleEl.textContent = title;
            modalBodyEl.innerHTML = ''; // Clear previous content
            if (typeof bodyContent === 'string') {
                modalBodyEl.innerHTML = bodyContent;
            } else {
                modalBodyEl.appendChild(bodyContent); // Append DOM element
            }
            modalConfirmBtn.textContent = confirmText;
            modalConfirmBtn.onclick = () => { // Remove previous listener by reassigning
                confirmCallback();
                closeModal();
            };
            genericModal.style.display = 'flex';
        }

        function closeModal() {
            genericModal.style.display = 'none';
            modalBodyEl.innerHTML = '';
            currentEditId = null;
            currentEditType = '';
        }

        function handleEditTransaction(e) {
            currentEditId = e.target.dataset.id;
            currentEditType = 'transaction';
            const transaction = allTransactions.find(t => t.id === currentEditId);
            if (!transaction) return;

            const formHtml = `
                <form id="editTransactionModalForm" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Type</label>
                        <select id="editTransactionType" class="input-field w-full mt-1">
                            <option value="expense" ${transaction.type === 'expense' ? 'selected' : ''}>Expense</option>
                            <option value="income" ${transaction.type === 'income' ? 'selected' : ''}>Income</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Amount</label>
                        <input type="number" id="editTransactionAmount" value="${transaction.amount}" class="input-field w-full mt-1" step="0.01">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="editTransactionCategory" value="${transaction.category}" class="input-field w-full mt-1" list="commonCategories">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="editTransactionDate" value="${formatDate(transaction.date)}" class="input-field w-full mt-1">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Note</label>
                        <textarea id="editTransactionNote" rows="2" class="input-field w-full mt-1">${transaction.note || ''}</textarea>
                    </div>
                </form>
            `;
            openModal("Edit Transaction", formHtml, async () => {
                const updatedData = {
                    type: document.getElementById('editTransactionType').value,
                    amount: document.getElementById('editTransactionAmount').value,
                    category: document.getElementById('editTransactionCategory').value.trim(),
                    date: document.getElementById('editTransactionDate').value,
                    note: document.getElementById('editTransactionNote').value.trim(),
                };
                if (!updatedData.category) { alert("Category cannot be empty."); return; }
                await updateTransaction(currentEditId, updatedData);
            });
        }

        function handleDeleteTransaction(e) {
            const id = e.target.dataset.id;
            const transaction = allTransactions.find(t => t.id === id);
            if (!transaction) return;
            openModal(
                "Confirm Deletion", 
                `<p>Are you sure you want to delete the transaction: <br><strong>${transaction.category} - ${formatCurrency(transaction.amount)}</strong> on ${formatDate(transaction.date)}?</p>`,
                async () => await deleteTransaction(id),
                "Yes, Delete"
            );
            modalConfirmBtn.classList.remove('btn-primary');
            modalConfirmBtn.classList.add('btn-danger');
        }
        
        function handleEditBudget(e) {
            currentEditId = e.target.dataset.id;
            currentEditType = 'budget';
            const budget = allBudgets.find(b => b.id === currentEditId);
            if (!budget) return;

            const formHtml = `
                <form id="editBudgetModalForm" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="editBudgetCategory" value="${budget.category}" class="input-field w-full mt-1" list="commonCategories" readonly>
                         <p class="text-xs text-gray-500">Category cannot be changed. Delete and create a new one if needed.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Monthly Limit</label>
                        <input type="number" id="editBudgetLimit" value="${budget.limit}" class="input-field w-full mt-1" step="0.01">
                    </div>
                     <input type="hidden" id="editBudgetMonthYear" value="${budget.monthYear}">
                </form>
            `;
             openModal("Edit Budget", formHtml, async () => {
                const updatedData = {
                    category: document.getElementById('editBudgetCategory').value, // Stays the same
                    limit: document.getElementById('editBudgetLimit').value,
                    monthYear: document.getElementById('editBudgetMonthYear').value, // Stays the same
                };
                await addOrUpdateBudget(updatedData); // Uses addOrUpdateBudget as it handles existing
            });
        }

        function handleDeleteBudget(e) {
            const id = e.target.dataset.id;
            const budget = allBudgets.find(b => b.id === id);
            if (!budget) return;
             openModal(
                "Confirm Deletion", 
                `<p>Are you sure you want to delete the budget for <strong>${budget.category}</strong> (${formatCurrency(budget.limit)})?</p>`,
                async () => await deleteBudget(id),
                "Yes, Delete"
            );
            modalConfirmBtn.classList.remove('btn-primary');
            modalConfirmBtn.classList.add('btn-danger');
        }

    </script>
</body>
</html>
